<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Operator</title>

<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' rel='stylesheet' />
<script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>
var map = L.mapbox.map('map', 'examples.map-20v6611k')
    .setView([49.84, 23.99], 11);

var layers = {};

var sock = new SockJS('/sockjs/operator');
sock.onopen = function() {
    console.log('open');
    subscribe();
};

sock.onmessage = function(e) {
    console.log('message', e);
    var msg = JSON.parse(e.data);
    switch (msg.cmd) {
        case 'agents':
            addMarkers(msg.agents);
            break;

        case 'leave':
            removeMarkers(msg.ids);
            break;

        default:
            console.error('unknown command:', msg);
    }
};

sock.onclose = function() {
    console.log('close');
};

function subscribe() {
    var channels = ['all'];
    if (window.location.search) {
        channels = window.location.search.substr(1).split(',');
    }
    console.log('subscribing to channels:', channels);
    channels.forEach(function(channel) {
        var msg = {
            cmd: 'subscribe',
            channel: channel
        };
        sock.send(JSON.stringify(msg));
    });
}

function addMarkers(agents) {
    agents.forEach(addMarker);
}

function addMarker(agent) {
    var position = agent.position;
    layers[agent.id] = L.mapbox.featureLayer({
        // this feature is in the GeoJSON format: see geojson.org
        // for the full specification
        type: 'Feature',
        geometry: {
            type: 'Point',
            // coordinates here are in longitude, latitude order because
            // x, y is the standard for GeoJSON and many formats
            coordinates: [position.coords.longitude, position.coords.latitude]
        },
        properties: {
            title: 'ID: ' + agent.id,
            description: 'Just one of me',
            // one can customize markers by adding simplestyle properties
            // http://mapbox.com/developers/simplestyle/
            'marker-size': 'large',
            'marker-color': '#f0a'
        }
    });
    layers[agent.id].addTo(map)
}

function removeMarkers(ids) {
    ids.forEach(function(id) {
        removeMarker(id);
    });
}

function removeMarker(id) {
    var layer = layers[id];
    if (!layer) {
        return;
    }
    map.removeLayer(layer);
}
</script>
</body>
</html>
